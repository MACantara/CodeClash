{% extends "base.html" %}

{% block title %}Spectating Match - CodeClash{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-7xl mx-auto">
        <!-- Match Header -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-6 border border-gray-700">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold mb-2">
                        <i class="bi bi-eye-fill text-purple-500"></i> Spectating Match
                    </h1>
                    <p class="text-gray-400">{{ match.challenge_name }} - {{ match.difficulty }}</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-400">
                        <i class="bi bi-people-fill"></i> <span id="spectatorCount">0</span> spectators
                    </div>
                    <div class="text-sm text-gray-500">Match Status: <span id="matchStatus" class="font-bold">{{ match.status }}</span></div>
                </div>
            </div>
        </div>

        <!-- Players Grid -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- Player 1 -->
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-blue-500">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-blue-400">
                        <i class="bi bi-person-circle"></i> {{ match.player1_name }}
                    </h2>
                    <div class="text-sm">
                        <span class="px-3 py-1 rounded" id="player1Status">
                            {{ 'Finished' if match.player1_completed else 'In Progress' }}
                        </span>
                    </div>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Errors:</span>
                        <span class="font-bold text-red-400" id="player1Errors">{{ match.player1_errors or 0 }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Time:</span>
                        <span class="font-bold text-green-400" id="player1Time">
                            {% if match.player1_time %}{{ "%.2f"|format(match.player1_time) }}s{% else %}--{% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Player 2 -->
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 border border-purple-500">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-purple-400">
                        <i class="bi bi-person-circle"></i> {{ match.player2_name }}
                    </h2>
                    <div class="text-sm">
                        <span class="px-3 py-1 rounded" id="player2Status">
                            {{ 'Finished' if match.player2_completed else 'In Progress' }}
                        </span>
                    </div>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Errors:</span>
                        <span class="font-bold text-red-400" id="player2Errors">{{ match.player2_errors or 0 }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Time:</span>
                        <span class="font-bold text-green-400" id="player2Time">
                            {% if match.player2_time %}{{ "%.2f"|format(match.player2_time) }}s{% else %}--{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Challenge Info -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-6 border border-gray-700">
            <h2 class="text-xl font-bold mb-3">Challenge: {{ match.challenge_name }}</h2>
            <div class="prose prose-invert max-w-none">
                <p class="text-gray-300">{{ match.challenge_description }}</p>
            </div>
        </div>

        <!-- Winner Banner (shown when match completes) -->
        <div id="winnerBanner" class="hidden bg-gradient-to-r from-yellow-600 to-orange-600 rounded-lg shadow-xl p-6 text-center">
            <h2 class="text-3xl font-bold mb-2">
                <i class="bi bi-trophy-fill"></i> <span id="winnerName"></span> Wins!
            </h2>
            <p class="text-lg">Match Complete</p>
        </div>

        <!-- Actions -->
        <div class="flex gap-4 justify-center mt-6">
            <a href="/lobby" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded transition">
                <i class="bi bi-arrow-left"></i> Back to Lobby
            </a>
            <a href="/match/{{ match.id }}/replay" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded transition">
                <i class="bi bi-play-circle"></i> Watch Replay
            </a>
        </div>
    </div>
</div>

<script>
const matchId = {{ match.id }};

// Poll for match updates
setInterval(async () => {
    try {
        const response = await fetch(`/match/${matchId}/spectator_data`);
        const data = await response.json();
        
        // Update spectator count
        document.getElementById('spectatorCount').textContent = data.spectator_count;
        
        // Update match status
        document.getElementById('matchStatus').textContent = data.status;
        
        // Update player 1
        document.getElementById('player1Errors').textContent = data.player1_errors || 0;
        if (data.player1_time) {
            document.getElementById('player1Time').textContent = data.player1_time.toFixed(2) + 's';
        }
        document.getElementById('player1Status').textContent = data.player1_completed ? 'Finished' : 'In Progress';
        
        // Update player 2
        document.getElementById('player2Errors').textContent = data.player2_errors || 0;
        if (data.player2_time) {
            document.getElementById('player2Time').textContent = data.player2_time.toFixed(2) + 's';
        }
        document.getElementById('player2Status').textContent = data.player2_completed ? 'Finished' : 'In Progress';
        
        // Show winner if match completed
        if (data.status === 'completed' && data.winner_name) {
            const banner = document.getElementById('winnerBanner');
            document.getElementById('winnerName').textContent = data.winner_name;
            banner.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error fetching spectator data:', error);
    }
}, 2000); // Update every 2 seconds
</script>
{% endblock %}
